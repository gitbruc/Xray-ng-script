# Generated by nginxconfig.io
# See nginxconfig.txt for the configuration share link

# 设置Nginx工作进程的用户为root
user                      root;
# 设置保存Nginx进程ID的文件路径
pid                       /run/nginx.pid;
# 设置工作进程数量为自动，根据CPU核心数动态调整
worker_processes          auto;
# 设置每个工作进程的最大打开文件数为65535
worker_rlimit_nofile      65535;
# 定义错误日志文件路径，日志级别为notice
error_log /var/log/nginx/error.log notice;

# Load modules
include                   /usr/local/nginx/conf/modules-enabled/*.conf;
#启用Nginx使用Google的tcmalloc作为其内存分配器，以优化内存管理性能。
google_perftools_profiles /dev/shm/nginx/tcmalloc/tcmalloc;

events {
    # 启用multi_accept，允许一个事件循环中同时接受多个新连接
    multi_accept       on;
    #设置每个工作进程的最大并发连接数为65535是一个常见的最大值，它告诉Nginx“尽你所能去处理”。它本身没有害处，但需要确保操作系统的文件描述符限制也足够高（例如，设置为1048576或更高）才能真正发挥其作用
    worker_connections 65535;
    #指定Nginx使用的事件模型。epoll 是一种高效的I/O事件通知机制，是Linux内核提供的高性能异步I/O接口。
    use                epoll;
}

http {
    # 设置默认字符集为UTF-8
    charset                utf-8;
    # 启用sendfile系统调用，提高文件传输效率
    sendfile               on;
    # 启用TCP_NOPUSH选项，减少网络包的发送数量
    tcp_nopush             on;
    # 启用TCP_NODELAY选项，避免Nagle算法延迟小数据包的发送
    tcp_nodelay            on;
    # 隐藏Nginx版本信息，增强安全性
    server_tokens          off;
    # 禁用记录404错误日志，以减少日志文件的大小。
    log_not_found          off;
    # 设置MIME类型哈希表的最大大小为2048
    types_hash_max_size    2048;
    # 设置MIME类型哈希表的桶大小为64
    types_hash_bucket_size 64;
    # 设置客户端请求体的最大大小为50MB
    client_max_body_size   50M;

    # MIME
    include                   mime.types;
    # 设置默认的MIME类型为application/octet-stream
    default_type              application/octet-stream;

    # Proxy和 FastCGI 请求/响应缓冲配置 ( WebSocket、SSE、Comet 或其他长连接/实时通信需求，和连接 SCGI 后端，这些 off 是必要的)
    # 禁用代理请求缓冲,减少内存占用。
    proxy_request_buffering off;
    # 禁用FastCGI请求缓冲
    fastcgi_request_buffering off;
    # 禁用SCGI请求缓冲
    scgi_request_buffering off;
    # 禁用代理响应缓冲
    proxy_buffering off;
    # 禁用FastCGI响应缓冲
    fastcgi_buffering off;
    # 禁用SCGI响应缓冲
    scgi_buffering off;

    #超时配置
    # 设置客户端请求头的超时时间为10秒
    client_header_timeout 10s;
    # 设置客户端请求体的超时时间为60秒
    client_body_timeout 60s;
    # 设置响应发送超时时间为60秒
    send_timeout 60s;
    # 设置长连接超时时间，65秒后断开客户端，20秒后断开代理服务器
    keepalive_timeout 65s 20s;
    
    #优化了 Nginx 匹配 Server 块中的 server_name 指令的速度
    # 设置服务器名称哈希表的最大大小为8192
    server_names_hash_max_size 8192;
    # 设置服务器名称哈希表的桶大小为128,设置服务器名称哈希表的最大和桶大小，提高服务器名称的匹配速度。
    server_names_hash_bucket_size 128;
    
    # 设置打开文件缓存，最多缓存1000个文件，60秒不活动后移除缓存.这有助于提高性能，当频繁请求常用文件时尤其有效。
    open_file_cache max=1000 inactive=60s;
    # 设置缓存文件的有效期为3秒,当文件信息发生变化（例如文件被修改），缓存中的信息必须更新。此配置指定Nginx每3秒钟检查一次文件状态，从而保持缓存的准确性。
    open_file_cache_valid 3s;
    # 设置文件至少被使用2次才会被缓存,此配置设置至少要有两次请求同一个文件才会将该文件的访问信息缓存。这样可以避免频繁请求少见的资源而消耗缓存空间。
    open_file_cache_min_uses 2;
    # 缓存打开文件时发生的错误,开启此选项后，Nginx也会缓存打开文件期间发生的错误信息（如文件未找到），这可以减少对磁盘的频繁访问，提高性能，特别是当有大量404错误发生时。
    open_file_cache_errors on;

    # Logging
    #创建自定义变量 $client_ip 获取客户端真实 IP，其配置如下：
    map $http_x_forwarded_for $clientRealIp {
        "" $remote_addr;
        # 匹配第一个IPv4或IPv6地址
        "~*(?P<firstIp>([0-9a-f]{1,4}:){1,7}[0-9a-f]{1,4}|([0-9]{1,3}\.){3}[0-9]{1,3}),?.*" $firstIp;
        default $remote_addr;
    }

    map "$time_iso8601 # $msec" $time_iso8601_ms {
        "~(^[^+]+)(\+[0-9:]+) # \d+\.(\d+)$" $1.$3$2;
        # 匹配失败时的默认值
        default "$time_iso8601"; 
    }
    
    log_format main escape=json '{'
        '"timestamp":"$time_iso8601_ms",'
        '"server_ip":"$server_addr",'
        '"remote_ip":"$remote_addr",'
        #从 xray 日志中整合进去的真实客户端 IP
        '"client_real_ip":"$clientRealIp",'
        '"xff":"$http_x_forwarded_for",'
        '"remote_user":"$remote_user",'
        '"domain":"$host",'
        '"url":"$request_uri",'
        '"referer":"$http_referer",'
        '"upstreamtime":"$upstream_response_time",'
        '"responsetime":"$request_time",'
        '"request_method":"$request_method",'
        '"status":"$status",'
        '"response_length":"$bytes_sent",'
        '"request_length":"$request_length",'
        '"protocol":"$server_protocol",'
        '"upstreamhost":"$upstream_addr",'
        '"http_user_agent":"$http_user_agent"'
    '}';
    # 定义访问日志文件路径，使用main格式
    access_log /var/log/nginx/access.log main buffer=512k flush=1m;

    # SSL
    # 设置SSL会话超时时间为1天
    ssl_session_timeout       1d;
    # 设置SSL会话缓存大小为10MB
    ssl_session_cache         shared:SSL:10m;
    # 禁用SSL会话票据
    ssl_session_tickets       off;

    # Mozilla Intermediate configuration
    # 仅启用TLS 1.2和TLS 1.3协议
    ssl_protocols             TLSv1.2 TLSv1.3;
    #指示 Nginx 在 TLS 握手时优先使用服务器端指定的加密套件顺序，而不是客户端提供的顺序
    ssl_prefer_server_ciphers on;
    # 设置SSL加密套件
    ssl_ciphers               ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    #若使用 OpenSSL 库，此项配置参数需要 OpenSSL 库的版本不小于 3.0.0 构建才支持。
    ssl_ecdh_curve            x25519:secp521r1:secp384r1:secp256r1;

    # OCSP Stapling
    # 启用SSL证书OCSP Stapling
    ssl_stapling              on;
    # 启用OCSP响应验证
    ssl_stapling_verify       on;
    #指定DNS解析器,将解析到的IP地址缓存60秒
    resolver                  1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4 208.67.222.222 208.67.220.220 valid=60s;
    # 设置DNS解析超时时间为5秒
    resolver_timeout          2s;

    # 启用递归解析X-Forwarded-For头部，获取一个不在 set_real_ip_from 信任列表中的 IP 地址
    real_ip_recursive on;
    
    # Connection header for WebSocket reverse proxy
    # 默认情况下，设置Connection头部为upgrade
    map $http_upgrade $connection_upgrade {
        default upgrade;
        # 如果没有升级请求，则关闭连接
        ""      close;
    }

    map $remote_addr $proxy_forwarded_elem {
        # 对IPv4地址设置X-Forwarded-For头部格式
        # IPv4 addresses can be sent as-is
        ~^[0-9.]+$        "for=$remote_addr";
        # 对IPv6地址设置X-Forwarded-For头部格式
        # IPv6 addresses need to be bracketed and quoted
        ~^[0-9A-Fa-f:.]+$ "for=\"[$remote_addr]\"";
        ## 默认设置X-Forwarded-For头部为unknown
        # Unix domain socket names cannot be represented in RFC 7239 syntax
        default           "for=unknown";
    }

    map $http_forwarded $proxy_add_forwarded {
        #根据现有Forwarded头部内容添加自定义Forwarded头部信息
        # If the incoming Forwarded header is syntactically valid, append to it
        "~^(,[ \\t]*)*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*([ \\t]*,([ \\t]*([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?(;([!#$%&'*+.^_`|~0-9A-Za-z-]+=([!#$%&'*+.^_`|~0-9A-Za-z-]+|\"([\\t \\x21\\x23-\\x5B\\x5D-\\x7E\\x80-\\xFF]|\\\\[\\t \\x21-\\x7E\\x80-\\xFF])*\"))?)*)?)*$" "$http_forwarded, $proxy_forwarded_elem";
        # 默认情况下仅使用proxy_forwarded_elem
        # Otherwise, replace it
        default "$proxy_forwarded_elem";
    }

    # Load configs
    include /usr/local/nginx/conf/conf.d/*.conf;
    include /usr/local/nginx/conf/sites-enabled/*;
}
